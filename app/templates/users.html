{% extends "layout.html" %}
{% block title %}Users - Unified AceStream Platform{% endblock %}
{% block users_active %}active{% endblock %}
{% block page_title %}User Management{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="showAddUserModal()">
    <i class="bi bi-plus-circle"></i> Add User
</button>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">All Users</h5>
            </div>
            <div class="col-auto">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search users..." onkeyup="filterUsers()">
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Max Connections</th>
                        <th>Expiry</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadUsers() {
    try {
        const response = await fetch('/api/users?limit=100');
        const users = await response.json();
        
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        
        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="empty-state">
                            <i class="bi bi-people"></i>
                            <p>No users found. Add your first user.</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            users.forEach(user => {
                const row = document.createElement('tr');
                
                const userType = user.is_admin ? 'Admin' : (user.is_trial ? 'Trial' : 'Regular');
                const userTypeBadge = user.is_admin ? 'bg-danger' : (user.is_trial ? 'bg-warning' : 'bg-info');
                
                const expiryDate = user.expiry_date ? new Date(user.expiry_date).toLocaleDateString() : 'Never';
                const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
                
                row.innerHTML = `
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email || '<span class="text-muted">N/A</span>'}</td>
                    <td><span class="badge ${userTypeBadge}">${userType}</span></td>
                    <td>
                        <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${user.max_connections}</td>
                    <td>${expiryDate}</td>
                    <td>${lastLogin}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="showUserUrls('${user.username}', '${user.password_hash}')" title="View URLs">
                                <i class="bi bi-link-45deg"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="editUser(${user.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="resetPassword(${user.id})" title="Reset Password">
                                <i class="bi bi-key"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showAlert('Error loading users', 'danger');
    }
}

function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function showAddUserModal() {
    const modalHtml = `
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <div class="mb-3">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-control" id="addUsername" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password *</label>
                                <input type="password" class="form-control" id="addPassword" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="addEmail">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Connections</label>
                                <input type="number" class="form-control" id="addMaxConnections" value="1" min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expiry (days)</label>
                                <input type="number" class="form-control" id="addExpiryDays" placeholder="Leave empty for no expiry">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="addIsAdmin">
                                    <label class="form-check-label" for="addIsAdmin">Administrator</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="addIsTrial">
                                    <label class="form-check-label" for="addIsTrial">Trial User</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="addNotes" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('addUserModal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
    modal.show();
}

async function addUser() {
    try {
        const data = {
            username: document.getElementById('addUsername').value,
            password: document.getElementById('addPassword').value,
            email: document.getElementById('addEmail').value || null,
            max_connections: parseInt(document.getElementById('addMaxConnections').value),
            expiry_days: document.getElementById('addExpiryDays').value ? parseInt(document.getElementById('addExpiryDays').value) : null,
            is_admin: document.getElementById('addIsAdmin').checked,
            is_trial: document.getElementById('addIsTrial').checked,
            notes: document.getElementById('addNotes').value || null
        };
        
        if (!data.username || !data.password) {
            showAlert('Username and password are required', 'warning');
            return;
        }
        
        const response = await fetch('/api/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add user');
        }
        
        showAlert('User added successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
        loadUsers();
        
    } catch (error) {
        console.error('Error adding user:', error);
        showAlert('Error adding user: ' + error.message, 'danger');
    }
}

async function editUser(id) {
    try {
        const response = await fetch(`/api/users/${id}`);
        if (!response.ok) throw new Error('User not found');
        
        const user = await response.json();
        
        const modalHtml = `
            <div class="modal fade" id="editUserModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User: ${user.username}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="editUsername" value="${user.username}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editEmail" value="${user.email || ''}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password (leave empty to keep current)</label>
                                    <input type="password" class="form-control" id="editPassword" placeholder="Enter new password to change">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Connections</label>
                                    <input type="number" class="form-control" id="editMaxConnections" value="${user.max_connections}" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Expiry (days from now)</label>
                                    <input type="number" class="form-control" id="editExpiryDays" placeholder="Leave empty to keep current expiry">
                                    <small class="text-muted">Current expiry: ${user.expiry_date ? new Date(user.expiry_date).toLocaleDateString() : 'Never'}</small>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="editIsActive" ${user.is_active ? 'checked' : ''}>
                                        <label class="form-check-label" for="editIsActive">Active</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="editIsAdmin" ${user.is_admin ? 'checked' : ''}>
                                        <label class="form-check-label" for="editIsAdmin">Administrator</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="editIsTrial" ${user.is_trial ? 'checked' : ''}>
                                        <label class="form-check-label" for="editIsTrial">Trial User</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="editNotes" rows="2">${user.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveUser(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('editUserModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading user:', error);
        showAlert('Error loading user: ' + error.message, 'danger');
    }
}

async function saveUser(id) {
    try {
        const data = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value || null,
            max_connections: parseInt(document.getElementById('editMaxConnections').value),
            is_active: document.getElementById('editIsActive').checked,
            is_admin: document.getElementById('editIsAdmin').checked,
            is_trial: document.getElementById('editIsTrial').checked,
            notes: document.getElementById('editNotes').value || null
        };
        
        // Add password if provided
        const password = document.getElementById('editPassword').value;
        if (password) {
            data.password = password;
        }
        
        // Add expiry_days if provided
        const expiryDays = document.getElementById('editExpiryDays').value;
        if (expiryDays) {
            data.expiry_days = parseInt(expiryDays);
        }
        
        const response = await fetch(`/api/users/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update user');
        }
        
        showAlert('User updated successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        loadUsers();
        
    } catch (error) {
        console.error('Error updating user:', error);
        showAlert('Error updating user: ' + error.message, 'danger');
    }
}

async function resetPassword(id) {
    const newPassword = prompt('Enter new password for user:');
    if (!newPassword) return;
    
    try {
        const response = await fetch(`/api/users/${id}/reset-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_password: newPassword})
        });
        
        if (!response.ok) throw new Error('Failed to reset password');
        
        showAlert('Password reset successfully', 'success');
    } catch (error) {
        console.error('Error resetting password:', error);
        showAlert('Error resetting password: ' + error.message, 'danger');
    }
}

async function deleteUser(id) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    try {
        const response = await fetch(`/api/users/${id}`, {method: 'DELETE'});
        if (!response.ok) throw new Error('Failed to delete user');
        
        showAlert('User deleted successfully', 'success');
        loadUsers();
    } catch (error) {
        console.error('Error deleting user:', error);
        showAlert('Error deleting user: ' + error.message, 'danger');
    }
}

// Show user URLs modal
async function showUserUrls(username, passwordHash) {
    try {
        // Get base URL from current location or external_url setting
        const response = await fetch('/api/settings/external_url');
        let baseUrl = window.location.origin;
        
        if (response.ok) {
            const setting = await response.json();
            if (setting.value && setting.value.trim()) {
                baseUrl = setting.value.trim();
            }
        }
        
        // Note: We need the actual password, not the hash
        // For security, we'll show a note that password is needed
        const m3uUrl = `${baseUrl}/get.php?username=${username}&password=USER_PASSWORD&type=m3u_plus&output=ts`;
        const epgUrl = `${baseUrl}/xmltv.php?username=${username}&password=USER_PASSWORD`;
        const xtreamUrl = baseUrl;
        
        const modalHtml = `
            <div class="modal fade" id="userUrlsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-link-45deg"></i>
                                URLs for User: ${username}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Note:</strong> Replace <code>USER_PASSWORD</code> with the actual user password.
                            </div>
                            
                            <!-- M3U Playlist -->
                            <div class="mb-4">
                                <h6><i class="bi bi-file-earmark-play"></i> M3U Playlist URL</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="m3uUrl" value="${m3uUrl}" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('m3uUrl')" title="Copy">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Use this URL in IPTV players that support M3U playlists</small>
                            </div>
                            
                            <!-- EPG URL -->
                            <div class="mb-4">
                                <h6><i class="bi bi-calendar3"></i> EPG (XMLTV) URL</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="epgUrl" value="${epgUrl}" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('epgUrl')" title="Copy">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Electronic Program Guide in XMLTV format</small>
                            </div>
                            
                            <!-- Xtream Codes API -->
                            <div class="mb-4">
                                <h6><i class="bi bi-server"></i> Xtream Codes API Configuration</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label"><strong>Server URL:</strong></label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" id="xtreamUrl" value="${xtreamUrl}" readonly>
                                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('xtreamUrl')" title="Copy">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label"><strong>Username:</strong></label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" id="xtreamUsername" value="${username}" readonly>
                                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('xtreamUsername')" title="Copy">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <label class="form-label"><strong>Password:</strong></label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" value="USER_PASSWORD" readonly>
                                            <button class="btn btn-outline-secondary" disabled title="Use actual password">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Use these credentials in IPTV Smarters, TiviMate, Perfect Player, etc.</small>
                            </div>
                            
                            <!-- Compatible Players -->
                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle"></i> Compatible IPTV Players:</h6>
                                <ul class="mb-0">
                                    <li><strong>IPTV Smarters Pro</strong> - Use Xtream Codes API</li>
                                    <li><strong>TiviMate</strong> - Use Xtream Codes API or M3U URL</li>
                                    <li><strong>Perfect Player</strong> - Use M3U URL + EPG URL</li>
                                    <li><strong>VLC Media Player</strong> - Use M3U URL</li>
                                    <li><strong>Kodi</strong> - Use M3U URL or Xtream Codes API</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('userUrlsModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('userUrlsModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error showing user URLs:', error);
        showAlert('Error loading URLs: ' + error.message, 'danger');
    }
}

// Copy to clipboard function
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        showAlert('Copied to clipboard!', 'success');
    } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(element.value).then(() => {
            showAlert('Copied to clipboard!', 'success');
        }).catch(() => {
            showAlert('Failed to copy to clipboard', 'danger');
        });
    }
}

// Load users on page load
loadUsers();

// Refresh every minute
setInterval(loadUsers, 60000);
</script>
{% endblock %}
