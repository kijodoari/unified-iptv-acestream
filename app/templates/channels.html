{% extends "layout.html" %}

{% block title %}Channels - Unified AceStream Platform{% endblock %}
{% block channels_active %}active{% endblock %}
{% block page_title %}Channels Management{% endblock %}

{% block page_actions %}
<button class="btn btn-success me-2" id="checkChannelsBtn" onclick="checkAllChannels()">
    <i class="bi bi-check-circle"></i> Check Status
</button>
<button class="btn btn-primary" onclick="showAddChannelModal()">
    <i class="bi bi-plus-circle"></i> Add Channel
</button>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">All Channels</h5>
            </div>
            <div class="col-auto">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search channels..." onkeyup="filterChannels()">
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="channelsTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>AceStream ID</th>
                        <th>Status</th>
                        <th>Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadChannels() {
    try {
        const response = await fetch('/api/channels?limit=200');
        const channels = await response.json();
        
        const tbody = document.querySelector('#channelsTable tbody');
        tbody.innerHTML = '';
        
        if (channels.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No channels found. Add some channels or configure scraper URLs.</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            channels.forEach(channel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        ${channel.logo_url ? `<img src="${channel.logo_url}" alt="" style="width: 30px; height: 30px; object-fit: cover; margin-right: 8px;">` : ''}
                        ${channel.name}
                    </td>
                    <td>${channel.category || '<span class="text-muted">N/A</span>'}</td>
                    <td><code class="small">${channel.acestream_id ? channel.acestream_id.substring(0, 20) + '...' : 'N/A'}</code></td>
                    <td>
                        <span class="badge ${channel.is_online === true ? 'bg-success' : (channel.is_online === false ? 'bg-danger' : 'bg-secondary')}" id="status-${channel.id}">
                            ${channel.is_online === true ? 'Online' : (channel.is_online === false ? 'Offline' : 'Unknown')}
                        </span>
                    </td>
                    <td>${new Date(channel.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="playChannel(${channel.id})">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="editChannel(${channel.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteChannel(${channel.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (error) {
        console.error('Error loading channels:', error);
        showAlert('Error loading channels', 'danger');
    }
}

function filterChannels() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#channelsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

async function playChannel(id) {
    try {
        // Get channel details
        const response = await fetch(`/api/channels/${id}`);
        if (!response.ok) {
            throw new Error('Channel not found');
        }
        
        const channel = await response.json();
        
        if (!channel.acestream_id) {
            showAlert('Este canal no tiene AceStream ID configurado', 'warning');
            return;
        }
        
        // Build URLs
        const username = '{{ admin_username }}';
        const password = '{{ admin_password }}';
        const streamUrlTs = `/live/${username}/${password}/${id}.ts`;
        const hlsUrl = `/api/hls/${id}/manifest.m3u8`;
        
        // Create modal with video player
        const modalHtml = `
            <div class="modal fade" id="playerModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                ${channel.logo_url ? `<img src="${channel.logo_url}" style="height: 30px; margin-right: 10px;">` : ''}
                                ${channel.name}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <video id="channelPlayer" controls autoplay style="width: 100%; max-height: 70vh; background: #000;"></video>
                            <div class="mt-3">
                                <p><strong>Categor√≠a:</strong> ${channel.category || 'N/A'}</p>
                                <p><strong>AceStream ID:</strong> <code>${channel.acestream_id}</code></p>
                                <hr>
                                <h6>URL para Reproductores Externos (VLC, AceStream Smarters)</h6>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control form-control-sm" id="streamUrlInput" value="${window.location.origin}${streamUrlTs}" readonly>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyStreamUrl()">
                                        <i class="bi bi-clipboard"></i> Copiar
                                    </button>
                                </div>
                                <small class="text-muted">Usa esta URL en VLC, AceStream Smarters, Perfect Player, TiviMate, etc.</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <a href="${streamUrlTs}" class="btn btn-primary" target="_blank">
                                <i class="bi bi-box-arrow-up-right"></i> Abrir en Reproductor Externo
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('playerModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('playerModal'));
        modal.show();
        
        // Initialize HLS player
        const video = document.getElementById('channelPlayer');
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(hlsUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
            });
            
            // Store hls instance for cleanup
            video.hlsInstance = hls;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Native HLS support (Safari)
            video.src = hlsUrl;
            video.addEventListener('loadedmetadata', function() {
                video.play();
            });
        }
        
        // Clean up when modal is closed
        document.getElementById('playerModal').addEventListener('hidden.bs.modal', function () {
            const player = document.getElementById('channelPlayer');
            if (player) {
                if (player.hlsInstance) {
                    player.hlsInstance.destroy();
                }
                player.pause();
                player.src = '';
            }
            this.remove();
        });
        
    } catch (error) {
        console.error('Error playing channel:', error);
        showAlert('Error loading channel: ' + error.message, 'danger');
    }
}

function copyStreamUrl() {
    const input = document.getElementById('streamUrlInput');
    input.select();
    document.execCommand('copy');
    showAlert('URL copiada al portapapeles', 'success');
}

async function editChannel(id) {
    try {
        const response = await fetch(`/api/channels/${id}`);
        if (!response.ok) {
            throw new Error('Channel not found');
        }
        
        const channel = await response.json();
        
        // Create edit modal
        const modalHtml = `
            <div class="modal fade" id="editModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Channel</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editChannelForm">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-control" id="editName" value="${channel.name}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <input type="text" class="form-control" id="editCategory" value="${channel.category || ''}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Logo URL</label>
                                    <input type="url" class="form-control" id="editLogoUrl" value="${channel.logo_url || ''}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">EPG ID</label>
                                    <input type="text" class="form-control" id="editEpgId" value="${channel.epg_id || ''}">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="editIsActive" ${channel.is_active ? 'checked' : ''}>
                                        <label class="form-check-label" for="editIsActive">Active</label>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveChannel(${id})">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('editModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
        
    } catch (error) {
        console.error('Error loading channel:', error);
        showAlert('Error loading channel: ' + error.message, 'danger');
    }
}

async function saveChannel(id) {
    try {
        const data = {
            name: document.getElementById('editName').value,
            category: document.getElementById('editCategory').value,
            logo_url: document.getElementById('editLogoUrl').value,
            epg_id: document.getElementById('editEpgId').value,
            is_active: document.getElementById('editIsActive').checked
        };
        
        const response = await fetch(`/api/channels/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Failed to update channel');
        }
        
        showAlert('Channel updated successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        loadChannels();
        
    } catch (error) {
        console.error('Error saving channel:', error);
        showAlert('Error saving channel: ' + error.message, 'danger');
    }
}

async function deleteChannel(id) {
    if (!confirm('Are you sure you want to delete this channel?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/channels/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete channel');
        }
        
        showAlert('Channel deleted successfully', 'success');
        loadChannels();
        
    } catch (error) {
        console.error('Error deleting channel:', error);
        showAlert('Error deleting channel: ' + error.message, 'danger');
    }
}

function showAddChannelModal() {
    const modalHtml = `
        <div class="modal fade" id="addModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Channel</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addChannelForm">
                            <div class="mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="addName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">AceStream ID</label>
                                <input type="text" class="form-control" id="addAcestreamId" placeholder="40 character hash">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Stream URL</label>
                                <input type="url" class="form-control" id="addStreamUrl" placeholder="http://...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="addCategory">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Logo URL</label>
                                <input type="url" class="form-control" id="addLogoUrl">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">EPG ID</label>
                                <input type="text" class="form-control" id="addEpgId">
                            </div>
                            <p class="text-muted small">* At least one of AceStream ID or Stream URL is required</p>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addChannel()">Add Channel</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('addModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addModal'));
    modal.show();
}

async function addChannel() {
    try {
        const data = {
            name: document.getElementById('addName').value,
            acestream_id: document.getElementById('addAcestreamId').value,
            stream_url: document.getElementById('addStreamUrl').value,
            category: document.getElementById('addCategory').value,
            logo_url: document.getElementById('addLogoUrl').value,
            epg_id: document.getElementById('addEpgId').value
        };
        
        if (!data.name) {
            showAlert('Channel name is required', 'warning');
            return;
        }
        
        if (!data.acestream_id && !data.stream_url) {
            showAlert('Either AceStream ID or Stream URL is required', 'warning');
            return;
        }
        
        const response = await fetch('/api/channels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Failed to add channel');
        }
        
        showAlert('Channel added successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
        loadChannels();
        
    } catch (error) {
        console.error('Error adding channel:', error);
        showAlert('Error adding channel: ' + error.message, 'danger');
    }
}

// Check all channels status with real-time progress
async function checkAllChannels() {
    const btn = document.getElementById('checkChannelsBtn');
    const originalHtml = btn.innerHTML;
    
    try {
        // Disable button and show spinner
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Checking...';
        
        // Create EventSource for SSE
        const eventSource = new EventSource('/api/channels/check/stream');
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'start':
                        console.log('Check started:', data.message);
                        break;
                    
                    case 'info':
                        console.log('Info:', data.message);
                        // Si es el mensaje de reset, actualizar todos los badges a gris
                        if (data.message.includes('Reset') && data.message.includes('Unknown')) {
                            // Resetear todos los badges a Unknown (gris)
                            const allBadges = document.querySelectorAll('[id^="status-"]');
                            allBadges.forEach(badge => {
                                badge.className = 'badge bg-secondary';
                                badge.textContent = 'Unknown';
                            });
                        }
                        break;
                    
                    case 'checking':
                        // Update button text with current channel
                        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Checking ${data.index}/${data.total}: ${data.channel.name}`;
                        break;
                    
                    case 'progress':
                        // Update status badge in real-time
                        const statusBadge = document.getElementById(`status-${data.channel.id}`);
                        if (statusBadge) {
                            if (data.channel.status === 'online') {
                                statusBadge.className = 'badge bg-success';
                                statusBadge.textContent = 'Online';
                            } else if (data.channel.status === 'offline') {
                                statusBadge.className = 'badge bg-danger';
                                statusBadge.textContent = 'Offline';
                            } else if (data.channel.status === 'skipped') {
                                statusBadge.className = 'badge bg-secondary';
                                statusBadge.textContent = 'Unknown';
                            } else if (data.channel.status === 'error') {
                                statusBadge.className = 'badge bg-danger';
                                statusBadge.textContent = 'Error';
                            }
                        }
                        
                        // Update button with stats
                        if (data.stats) {
                            btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Checking... (${data.stats.online} online, ${data.stats.offline} offline)`;
                        }
                        break;
                    
                    case 'complete':
                        console.log('Check completed:', data.message);
                        showAlert(`Check completed: ${data.details.online} online, ${data.details.offline} offline, ${data.details.skipped} skipped in ${data.details.elapsed_seconds}s`, 'success');
                        eventSource.close();
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                        break;
                    
                    case 'error':
                        console.error('Check error:', data.message);
                        showAlert('Error checking channels: ' + data.message, 'danger');
                        eventSource.close();
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                        break;
                }
            } catch (e) {
                console.error('Error parsing SSE data:', e);
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('SSE error:', error);
            showAlert('Connection error during channel check', 'danger');
            eventSource.close();
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        };
        
    } catch (error) {
        console.error('Error checking channels:', error);
        showAlert('Error checking channels: ' + error.message, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// Load channels on page load
loadChannels();

// Refresh every minute
setInterval(loadChannels, 60000);
</script>
{% endblock %}
